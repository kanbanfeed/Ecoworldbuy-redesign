<% const creditTotal = Math.round(total); %>

<section class="container fade-in-up" style="padding-top:3rem; margin-bottom:2rem;">
    <div class="section-heading">
        <div>
            <h1>Your bag</h1>
            <p style="color:var(--text-muted);">(<%= cart.length %> items) Carbon-neutral shipping is always on us.</p>
        </div>
        <a href="/shop" class="link-arrow">Continue shopping <i class="bi bi-arrow-right"></i></a>
    </div>
</section>

<section class="container fade-in-up" style="margin-bottom:4rem;">
    <% if (cart.length === 0) { %>
        <div class="cart-card" style="text-align:center; display:flex; flex-direction:column; align-items:center; padding:3rem;">
            <i class="bi bi-bag" style="font-size:3rem; color:#d1d5db; margin-bottom:1rem;"></i>
            <h3>Nothing in your bag yet</h3>
            <p style="color:var(--text-muted); max-width:380px;">Discover our bestselling eco essentials and build your ritual.</p>
            <a href="/shop" class="btn btn-primary" style="margin-top:1rem;">Shop the collection</a>
        </div>
    <% } else { %>
        <div class="cart-wrapper">
            <div class="cart-items" style="display:flex; flex-direction:column; gap:1rem;">
                <% cart.forEach(item => { %>
                    <div class="cart-card">
                        <img src="<%= item.image %>" alt="<%= item.name %>">
                        <div style="display:flex; flex-direction:column; gap:0.35rem;">
                            <strong><%= item.name %></strong>
                            <span style="color:var(--text-muted);">Eco essentials</span>
                            <div style="font-weight:700; color:var(--primary);">$<%= item.price.toFixed(2) %></div>
                            <span class="credit-chip"><i class="bi bi-lightning-charge"></i><%= Math.round(item.price * item.quantity) %> credits</span>
                            <div class="cart-qty">
                                <form action="/update-cart" method="POST" style="margin:0;">
                                    <input type="hidden" name="productId" value="<%= item.id %>">
                                    <input type="hidden" name="action" value="decrease">
                                    <button type="submit">-</button>
                                </form>
                                <span style="min-width:30px; text-align:center; font-weight:600;"><%= item.quantity %></span>
                                <form action="/update-cart" method="POST" style="margin:0;">
                                    <input type="hidden" name="productId" value="<%= item.id %>">
                                    <input type="hidden" name="action" value="increase">
                                    <button type="submit">+</button>
                                </form>
                            </div>
                        </div>
                        <form action="/update-cart" method="POST" style="margin:0;">
                            <input type="hidden" name="productId" value="<%= item.id %>">
                            <input type="hidden" name="action" value="remove">
                            <button style="border:none; background:none; color:#ef4444; font-size:1.2rem; cursor:pointer;">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </div>
                <% }); %>
            </div>

            <div class="cart-summary">
                <div class="summary-card">
                    <h3 style="margin-bottom:1.5rem;">Order summary</h3>
                    <div class="summary-line">
                        <span>Subtotal</span>
                        <span>$<%= total.toFixed(2) %></span>
                    </div>
                    <div class="summary-line">
                        <span>Shipping</span>
                        <span style="color:var(--primary); font-weight:600;">Free</span>
                    </div>
                    <div class="summary-line">
                        <span>Credits</span>
                        <span><%= creditTotal %></span>
                    </div>
                    <div class="summary-line">
                        <span>Member boost (2Ã—)</span>
                        <span><%= creditTotal * 2 %></span>
                    </div>
                    <div class="summary-total">
                        <span>Total</span>
                        <span>$<%= total.toFixed(2) %></span>
                    </div>

                    <button id="checkoutBtn" onclick="processCheckout()" class="checkout-btn">
                        Secure checkout
                    </button>
                    <p style="text-align:center; margin-top:0.75rem; font-size:0.85rem; color:var(--text-muted); display:flex; justify-content:center; gap:0.35rem;">
                        <i class="bi bi-lock-fill"></i> Encrypted with Crowbar Pay
                    </p>
                </div>
            </div>
        </div>
    <% } %>
</section>

<script>
    function processCheckout() {
        const btn = document.getElementById('checkoutBtn');
        if (!btn) return;
        btn.innerText = "Processing...";
        btn.style.opacity = "0.7";
        btn.style.cursor = "not-allowed";
        btn.disabled = true;

        const session = localStorage.getItem('crowbar_session');
        setTimeout(() => {
            if (session) {
                window.location.href = 'https://www.crowbarltd.com/demo-checkout';
            } else {
                window.location.href = '/login';
            }
        }, 800);
    }

    window.addEventListener('pageshow', function() {
        const btn = document.getElementById('checkoutBtn');
        if (btn) {
            btn.innerText = "Secure checkout";
            btn.style.opacity = "1";
            btn.style.cursor = "pointer";
            btn.disabled = false;
        }
    });
</script>